---
title: "Benchmark Analyzer"
server: shiny
format: 
  dashboard:
    scrolling: true 
    orientation: rows
---

```{r echo=FALSE, message=FALSE, msg = F, warning = F, error = F}
#| context: setup


library(magrittr)
library(shiny) 
library(lubridate)
library(reactable) 
library(reactablefmtr) 
library(crosstalk) 
library(plotly)
library(bslib) 
library(bsicons) 
library(htmltools) 

library(tidyverse, quietly = TRUE)

targets::tar_source(files = "R")

```


## Input {.fill height = 10%}

```{r}
#| panel: input

fileInput(
    inputId = "peak_force", label = "Upload Peak Force", multiple = F, accept = ".csv"
  )

# fileInput(
#     inputId = "rate_force", label = "Upload RFD Data", multiple = F, accept = ".csv"
#   )

```

## Input {.flow height = 5%}
```{r}
uiOutput("peak_force_grip_select")
```

## Input {.flow height = 40%}
```{r}
plotlyOutput("peak_force_trace")
```

## Input {.flow height = 40%}
```{r}
plotlyOutput("peak_force_boxplot")
```

## Input {.flow height = 40%}

```{r}
reactableOutput('table_peak_force')
```

```{r}
#| context: server

peak_force = shiny::reactive({
  file <- input$peak_force
  ext <- tools::file_ext(file$datapath)
  
  req(file)
  validate(need(ext == "csv", "Please upload a csv file"))
  
  temp_data = read.csv(file$datapath)
  
  assign("butt", temp_data, envir = .GlobalEnv)
  
  # temp_data %>% process_peak_force() %>%  print()
  
  temp_data  = temp_data %>% 
    process_peak_force()
  
  return(temp_data)
})


peak_force_shared = shiny::reactive({
  temp_shared = SharedData$new(peak_force())
  
  return(temp_shared)
})


output$table_peak_force <- renderReactable({
  
  tmp_table = peak_force() %>% 
    reactable()

  return(tmp_table)
})


output$peak_force_grip_select = renderUI({
  crosstalk::filter_select(id = "peak_force", label = "Grip Type", peak_force_shared(), ~grip_type, multiple = T)
})

output$peak_force_trace = renderPlotly({
  tmp_plot = peak_force_shared() %>%
      plot_ly(
        x = ~rep_number, y = ~value, color = ~hand
        ,split = ~grip_type
        ,mode = 'lines+markers') %>%
      layout(
        xaxis = list(title = "Max Force (lbf)")
        ,yaxis = list(title = "Rep Number")
      )
  
  return(tmp_plot)
})

output$peak_force_boxplot = renderPlotly({
  tmp_plot = (peak_force()  %>%
                ggplot() + 
                geom_boxplot(aes(value_centered)) + 
                geom_point(aes(value_centered, 0, color = current_session)) + 
                labs(color = "Most recent") + 
                theme(legend.position = "top") + 
                facet_grid(rows = vars(grip_type))
              ) %>% 
    ggplotly()
  
  return(tmp_plot)
})


```




